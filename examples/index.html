<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Cesium Universal Manipulator Demo</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/cesium@1.133.0/Build/Cesium/Widgets/widgets.css"
    />
    <link rel="stylesheet" href="src/styles.css" />
    <script>
      window.CESIUM_BASE_URL =
        'https://cdn.jsdelivr.net/npm/cesium@1.133.0/Build/Cesium/';
    </script>
    <script src="https://cdn.jsdelivr.net/npm/cesium@1.133.0/Build/Cesium/Cesium.js"></script>
  </head>
  <body>
    <div id="cesiumContainer"></div>
    <div class="panel">
      <label>
        Mode
        <select id="mode">
          <option value="translate">Translate</option>
          <option value="rotate">Rotate</option>
          <option value="scale">Scale</option>
        </select>
      </label>
      <label>
        Orientation
        <select id="orientation">
          <option value="global">Global</option>
          <option value="local">Local</option>
          <option value="view">View</option>
          <option value="enu">ENU</option>
          <option value="normal">Normal</option>
          <option value="gimbal">Gimbal</option>
        </select>
      </label>
      <div class="row" id="orientation-normal" hidden>
        <span>Normal (XYZ)</span>
        <input id="normal-x" type="number" value="0" step="0.1" />
        <input id="normal-y" type="number" value="0" step="0.1" />
        <input id="normal-z" type="number" value="1" step="0.1" />
      </div>
      <div class="row" id="orientation-gimbal" hidden>
        <label>
          Gimbal yaw (°)
          <input id="gimbal-yaw" type="number" value="0" step="5" />
        </label>
        <label>
          Gimbal pitch (°)
          <input id="gimbal-pitch" type="number" value="0" step="5" />
        </label>
      </div>
      <label>
        Pivot
        <select id="pivot">
          <option value="origin">Origin</option>
          <option value="median">Median</option>
          <option value="cursor">Cursor</option>
          <option value="individual">Individual</option>
        </select>
      </label>
      <label>
        Snap (meters)
        <input id="snap-translate" type="number" value="1" step="0.1" />
      </label>
      <label>
        Snap (degrees)
        <input id="snap-rotate" type="number" value="5" step="1" />
      </label>
      <label>
        Snap (scale)
        <input id="snap-scale" type="number" value="0.1" step="0.1" />
      </label>
      <div class="row buttons">
        <button id="undo">Undo</button>
        <button id="redo">Redo</button>
      </div>
      <div class="help">
        <p>
          While dragging, hold <kbd>Ctrl</kbd> for snapping, <kbd>Shift</kbd> for fine adjustments, or type
          values such as <code>5m</code>, <code>0.5</code>, or <code>90°</code> then press <kbd>Enter</kbd> to
          apply. Press <kbd>Esc</kbd> or right-click to cancel.
        </p>
      </div>
      <div class="metrics">
        <h3>Performance</h3>
        <div id="metrics-fps">FPS: --</div>
        <div id="metrics-frame">Frame: -- ms</div>
        <div id="metrics-memory">Memory Δ: --</div>
        <button id="metrics-reset" type="button">Reset stats</button>
      </div>
    </div>
    <script type="module">
      import { UniversalManipulator } from '../src/index.js';

      const viewer = new Cesium.Viewer('cesiumContainer', {
        shouldAnimate: true,
      });

      viewer.scene.globe.enableLighting = true;

      const redBox = viewer.entities.add({
        name: 'Red box',
        position: Cesium.Cartesian3.fromDegrees(-75.59777, 40.03883, 100),
        box: {
          dimensions: new Cesium.Cartesian3(30, 30, 30),
          material: Cesium.Color.RED.withAlpha(0.8),
        },
      });

      const greenBox = viewer.entities.add({
        name: 'Green box',
        position: Cesium.Cartesian3.fromDegrees(-75.6, 40.04, 100),
        box: {
          dimensions: new Cesium.Cartesian3(20, 20, 40),
          material: Cesium.Color.LIME.withAlpha(0.8),
        },
      });

      viewer.zoomTo(viewer.entities);

      const manipulator = new UniversalManipulator({
        Cesium,
        viewer,
        target: [redBox, greenBox],
        mode: 'translate',
      });

      const modeSelect = document.getElementById('mode');
      const orientationSelect = document.getElementById('orientation');
      const pivotSelect = document.getElementById('pivot');
      const snapTranslate = document.getElementById('snap-translate');
      const snapRotate = document.getElementById('snap-rotate');
      const snapScale = document.getElementById('snap-scale');
      const normalRow = document.getElementById('orientation-normal');
      const normalInputs = {
        x: document.getElementById('normal-x'),
        y: document.getElementById('normal-y'),
        z: document.getElementById('normal-z'),
      };
      const gimbalRow = document.getElementById('orientation-gimbal');
      const gimbalYaw = document.getElementById('gimbal-yaw');
      const gimbalPitch = document.getElementById('gimbal-pitch');
      const undoButton = document.getElementById('undo');
      const redoButton = document.getElementById('redo');
      const metricsFps = document.getElementById('metrics-fps');
      const metricsFrame = document.getElementById('metrics-frame');
      const metricsMemory = document.getElementById('metrics-memory');
      const metricsReset = document.getElementById('metrics-reset');

      modeSelect.addEventListener('change', () => {
        manipulator.setMode(modeSelect.value);
      });
      orientationSelect.addEventListener('change', updateOrientation);
      pivotSelect.addEventListener('change', () => {
        manipulator.setPivot(pivotSelect.value);
      });

      function updateOrientation() {
        const type = orientationSelect.value;
        normalRow.hidden = type !== 'normal';
        gimbalRow.hidden = type !== 'gimbal';
        if (type === 'normal') {
          manipulator.setOrientation({
            type: 'normal',
            normal: {
              x: Number(normalInputs.x.value),
              y: Number(normalInputs.y.value),
              z: Number(normalInputs.z.value),
            },
          });
          return;
        }
        if (type === 'gimbal') {
          manipulator.setOrientation({
            type: 'gimbal',
            gimbal: {
              yaw: (Number(gimbalYaw.value) * Math.PI) / 180,
              pitch: (Number(gimbalPitch.value) * Math.PI) / 180,
            },
          });
          return;
        }
        manipulator.setOrientation(type);
      }

      gimbalYaw.addEventListener('input', updateOrientation);
      gimbalPitch.addEventListener('input', updateOrientation);
      Object.values(normalInputs).forEach((input) => {
        input.addEventListener('input', updateOrientation);
      });

      undoButton.addEventListener('click', () => manipulator.undo());
      redoButton.addEventListener('click', () => manipulator.redo());
      metricsReset.addEventListener('click', () => manipulator.resetPerformanceMetrics());

      function updateSnap() {
        manipulator.setSnap({
          translate: Number(snapTranslate.value),
          rotate: (Number(snapRotate.value) * Math.PI) / 180,
          scale: Number(snapScale.value),
        });
      }

      snapTranslate.addEventListener('input', updateSnap);
      snapRotate.addEventListener('input', updateSnap);
      snapScale.addEventListener('input', updateSnap);
      updateSnap();
      updateOrientation();

      function updateMetrics() {
        const metrics = manipulator.getPerformanceMetrics();
        if (metrics.frameSamples > 0) {
          metricsFps.textContent = `FPS: ${metrics.fps.toFixed(1)}`;
          metricsFrame.textContent = `Frame: ${metrics.averageFrameTime.toFixed(2)} ms`;
        } else {
          metricsFps.textContent = 'FPS: --';
          metricsFrame.textContent = 'Frame: -- ms';
        }
        if (metrics.memorySamples > 0 && metrics.averageMemory != null) {
          const deltaMb = metrics.memoryDelta / (1024 * 1024);
          metricsMemory.textContent = `Memory Δ: ${deltaMb.toFixed(2)} MB`;
        } else {
          metricsMemory.textContent = 'Memory Δ: n/a';
        }
      }

      setInterval(updateMetrics, 1000);
      updateMetrics();
    </script>
  </body>
</html>
